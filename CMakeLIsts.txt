cmake_minimum_required(VERSION 3.19)
project(PathTracing LANGUAGES CXX)
set(CMAKE_CXX_STANDARD 20)
set(CMAKE_CXX_STANDARD_REQUIRED ON)
#set(CMAKE_AUTOMOC ON)
#library
#qt
find_package(Qt6 6.8 REQUIRED COMPONENTS 
            Core
            Gui
            Widgets
            OpenGLWidgets
            )
qt_standard_project_setup()
#git
include(FetchContent)
#glm
FetchContent_Declare(
    GLM
    GIT_REPOSITORY https://github.com/g-truc/glm.git
    GIT_TAG 1.0.2
    GIT_SHALLOW 1
)
FetchContent_MakeAvailable(GLM)
#stb image
FetchContent_Declare(
    stb
    GIT_REPOSITORY https://github.com/nothings/stb.git
    GIT_TAG master
    GIT_SHALLOW 1
)
FetchContent_MakeAvailable(stb)
add_library(stb INTERFACE)
target_include_directories(stb INTERFACE
    ${stb_SOURCE_DIR}
)
#source code
file(GLOB_RECURSE SOURCES CONFIGURE_DEPENDS
    "${CMAKE_CURRENT_SOURCE_DIR}/src/*.cpp"
    "${CMAKE_CURRENT_SOURCE_DIR}/src/*.hpp"
)
#qt executable
qt_add_executable(${PROJECT_NAME} ${SOURCES})
#build
if(WIN32)
    target_link_libraries(${PROJECT_NAME}
        PRIVATE
            Qt::Core
            Qt::Gui
            Qt::Widgets
            Qt::OpenGLWidgets
            Qt::OpenGL
            glm
            stb
    )
    set_target_properties(${PROJECT_NAME}
        PROPERTIES
            RUNTIME_OUTPUT_DIRECTORY   "${CMAKE_SOURCE_DIR}/bin"
            RUNTIME_OUTPUT_DIRECTORY_DEBUG   "${CMAKE_SOURCE_DIR}/bin/Debug"
            RUNTIME_OUTPUT_DIRECTORY_RELEASE "${CMAKE_SOURCE_DIR}/bin/Release"
            OUTPUT_NAME_DEBUG   "${PROJECT_NAME}_debug"
            OUTPUT_NAME_RELEASE "${PROJECT_NAME}_release"
    )
    if (MSVC)
        target_compile_options(${PROJECT_NAME} PRIVATE /utf-8)
    endif()
elseif(APPLE)
    target_link_libraries(${PROJECT_NAME}
        PRIVATE
            Qt::Core
            Qt::Gui
            Qt::Widgets
            Qt::OpenGLWidgets
            Qt::OpenGL
            glm
            stbLib
            "-framework Cocoa"
            "-framework IOKit"
            "-framework CoreVideo"
    )
    set_target_properties(${PROJECT_NAME}
        PROPERTIES
            RUNTIME_OUTPUT_DIRECTORY   "${CMAKE_SOURCE_DIR}/bin"
            RUNTIME_OUTPUT_DIRECTORY_DEBUG   "${CMAKE_SOURCE_DIR}/bin/Debug"
            RUNTIME_OUTPUT_DIRECTORY_RELEASE "${CMAKE_SOURCE_DIR}/bin/Release"
            OUTPUT_NAME_DEBUG   "${PROJECT_NAME}_debug"
            OUTPUT_NAME_RELEASE "${PROJECT_NAME}_release"
            BUILD_RPATH "@executable_path"
            INSTALL_RPATH "@executable_path"
            RPATH_USE_LINK_PATH TRUE
    )
endif()
target_include_directories(${PROJECT_NAME}
    PRIVATE
        ${CMAKE_CURRENT_SOURCE_DIR}/src
        ${CMAKE_CURRENT_SOURCE_DIR}/src/component/public
        ${CMAKE_CURRENT_SOURCE_DIR}/src/core/public
        ${CMAKE_CURRENT_SOURCE_DIR}/src/renderer/public
        ${CMAKE_CURRENT_SOURCE_DIR}/src/resource/public
        ${CMAKE_CURRENT_SOURCE_DIR}/src/scene/public
        ${CMAKE_CURRENT_SOURCE_DIR}/src/system/public
    )
#qt include
include(GNUInstallDirs)
#qt install
install(TARGETS ${PROJECT_NAME}
    BUNDLE  DESTINATION .
    RUNTIME DESTINATION ${CMAKE_INSTALL_BINDIR}
    LIBRARY DESTINATION ${CMAKE_INSTALL_LIBDIR}
)
qt_generate_deploy_app_script(
    TARGET ${PROJECT_NAME}
    OUTPUT_SCRIPT deploy_script
    NO_UNSUPPORTED_PLATFORM_ERROR
)
install(SCRIPT ${deploy_script})
#assetsCopy
#set(assetDir "${CMAKE_SOURCE_DIR}/assets")
#set(assetDir_output "${CMAKE_SOURCE_DIR}/bin/$<CONFIG>")
#add_custom_target(assetsCopy ALL
#    COMMAND ${CMAKE_COMMAND} -E copy_directory
#            ${assetDir}
#            ${assetDir_output}
#    COMMENT "Copying assets..."
#)

#shaderCopy
#set(SHADER_SOURCE_DIR "${CMAKE_SOURCE_DIR}/src/shader")
#set(SHADER_OUTPUT_DIR "${CMAKE_SOURCE_DIR}/bin/$<CONFIG>/shader")
#add_custom_target(copy_shaders ALL
#    COMMAND ${CMAKE_COMMAND} -E copy_directory
#            ${SHADER_SOURCE_DIR}
#            ${SHADER_OUTPUT_DIR}
#    COMMENT "Copying shaders..."
#)

#cmake -B ./build -S ./ -G Ninja -DCMAKE_BUILD_TYPE=Debug
#windeployqt --no-network --no-translations --no-opengl-sw YourApp.exe
